{% extends "../base.html" %}
{% block content %}
<h1>{{ object.nombre }}</h1>
<h5>Ultima modificación: {{ object.ultima_actualizacion }}</h5>

<!-- Modal -->
<div class="modal fade" id="eliminarCandidatoModal" tabindex="-1" aria-labelledby="eliminarCandidatoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="eliminarCandidatoModalLabel">¿Seguro de eliminar al Candidato?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <b>¡No podrás deshacer esta acción!</b>. El Candidato será eliminado de este tablero, junto con la
                información adjunta. <br>
                <b>Candidado: </b> <i id="nombre-del-candidato-a-eliminar">Juan Alberto Arena.</i>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-danger" id="boton-eliminar-candidato">Entiendo. Eliminar.</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="agregarCandidatoModal" tabindex="-1" aria-labelledby="agregarCandidatoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="agregarCandidatoModalLabel">Añadir un nuevo candidato</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form class="form-nuevo-candidato" method="POST">
                    {% csrf_token %}
                    <div class="input-group">
                        <label class="input-group-text" for="nombre">Nombre(s) del Candidato</label>
                        <input id="nombre-candidato" class="form-control" type="text" name="nombre" maxlength="100"
                            placeholder="Santa Juana" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="apellidos">Apellido(s) del
                            Candidato</label>
                        <input id="apellidos-candidato" class="form-control" type="text" name="apellidos"
                            maxlength="100" placeholder="De la Cruz Saucedo" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="puesto_deseado">Puesto Deseado</label>
                        <input id="puesto-deseado" class="form-control" type="text" name="puesto_deseado"
                            maxlength="100" placeholder="Control de Máquinas" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="fecha-de-nacimiento">Fecha de
                            Nacimiento</label>
                        <input type="date" id="fecha-de-nacimiento" class="form-control" name="fecha_de_nacimiento"
                            required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="email">Email</label>
                        <input type="email" id="email" placeholder="correo@example.com" class="form-control"
                            name="email" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="telefono">Número de Teléfono</label>
                        <input type="tel" id="telefono" placeholder="4493846514" class="form-control" name="telefono"
                            required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="edo_civil">Estado Civil</label>
                        <select class="form-select" aria-label="Disabled select example" id="edo_civil"
                            name="edo_civil">
                            <option value="SOLTERO">Soltero</option>
                            <option value="CASADO">Casado</option>
                            <option value="DIVORCIADO">Divorciado</option>
                            <option value="VIUDI">Viudo</option>
                        </select>
                    </div><br>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" id="finalizar-agregar-candidato" class="btn btn-success">Añadir
                        Candidato.</button>
                </form>
            </div>
        </div>
    </div>
</div>

<button class="btn btn-success" id="agregar-candidato" data-bs-toggle="modal"
    data-bs-target="#agregarCandidatoModal">Añadir Candidato ⨁</button>
<div class="modal fade" id="eliminarArchivoComentarioModal" tabindex="-1" aria-labelledby="eliminarArchivoComentarioModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="eliminarArchivoComentarioModalLabel">¿Seguro de eliminar el elemento?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <b>¡No podrás deshacer esta acción!</b>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-danger" id="boton-eliminar-archivo-comentario">Entiendo. Eliminar.</button>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-xl fade" id="candidatoModal" tabindex="-1" aria-labelledby="candidatoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="candidatoModalLabel">Juan Alberto Arena</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <h4>Resumen del Candidato</h4>
                <form class="form-editar-candidato" method="POST">
                    {% csrf_token %}
                    <div class="input-group">
                        <label class="input-group-text" for="nombre">Nombre(s) del Candidato</label>
                        <input id="nombre-candidato-editar" class="form-control" type="text" name="nombre"
                            maxlength="100" placeholder="Santa Juana" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="apellidos">Apellido(s) del
                            Candidato</label>
                        <input id="apellidos-candidato-editar" class="form-control" type="text" name="apellidos"
                            maxlength="100" placeholder="De la Cruz Saucedo" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="puesto_deseado">Puesto Deseado</label>
                        <input id="puesto-deseado-editar" class="form-control" type="text" name="puesto_deseado"
                            maxlength="100" placeholder="Control de Máquinas" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="fecha-de-nacimiento-editar">Fecha de
                            Nacimiento</label>
                        <input type="date" id="fecha-de-nacimiento-editar" class="form-control"
                            name="fecha_de_nacimiento" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="email">Email</label>
                        <input type="email" id="email-editar" placeholder="correo@example.com" class="form-control"
                            name="email" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="telefono">Número de Teléfono</label>
                        <input type="tel" id="telefono-editar" placeholder="4493846514" class="form-control"
                            name="telefono" required>
                    </div><br>
                    <div class="input-group">
                        <label class="input-group-text" for="edo_civil-editar">Estado Civil</label>
                        <select class="form-select" aria-label="Disabled select example" id="edo_civil-editar"
                            name="edo_civil">
                            <option value="SOLTERO">Soltero</option>
                            <option value="CASADO">Casado</option>
                            <option value="DIVORCIADO">Divorciado</option>
                            <option value="VIUDI">Viudo</option>
                        </select>
                    </div><br>
                    <button type="submit" id="finalizar-editar-candidato" class="btn btn-primary">Guardar
                        Cambios</button>
                </form>
                <hr>
                <h4>Comentarios y Documentos</h4>
                <table class="table">
                    <tr>
                        <th>Hora y Fecha</th>
                        <th>Documento/Comentario</th>
                        <th>Generado en Fase</th>
                        <th>Eliminar</th>
                    </tr>
                    <tbody class="resumen-comentarios-archivos">
                        <tr>
                            <td>2023-09-12 11:00 pm</td>
                            <td>
                                <b>Usuario 1 Añadió:</b><br>
                                <a href="">Solicitud.pdf</a><br>
                                <b>Descripción:</b> CV del Candidato. <br>
                            </td>
                            <td>
                                Entrevista
                            </td>
                            <td>
                                <button class="btn btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#eliminarArchivoModal">❌</button>
                            </td>
                        </tr>
                        <tr>
                            <td>2023-09-13 11:20 am</td>
                            <td>
                                <b>Usuario 1 Comentó:</b><br>
                                <p><i>Se llamó al candidato esta mañana, la intención de la llamada era indicarle la
                                        fecha
                                        para entrevistarlo, no contestó. Intentaré llamar más tarde.</i></p>
                            </td>
                            <td>
                                Aplicantes
                            </td>
                            <td>
                                <button class="btn btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#eliminarArchivoModal">❌</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <hr>
                <nav>
                    <div class="nav nav-tabs m-3" id="nav-tab" role="tablist">
                        <button class="nav-link active" data-kind="comentario" id="nav-home-tab" data-bs-toggle="tab"
                            data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home"
                            aria-selected="true">Comentar</button>
                        <button class="nav-link" data-kind="documento" id="nav-profile-tab" data-bs-toggle="tab"
                            data-bs-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile"
                            aria-selected="false">Subir
                            Documento</button>
                    </div>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab"
                        tabindex="0">
                        <h4>Deja un Comentario</h4>
                        <div class="mb-3">
                            <label for="basic-url" class="form-label">Comenta:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="comentario-input">
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab"
                        tabindex="0">
                        <h4>Subir Documento</h4>
                        <div class="mb-3">
                            <input class="form-control" type="file" id="formFile">
                        </div>
                        <div class="mb-3">
                            <label for="basic-url" class="form-label">Añade una descripción del documento</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="documento-input">
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary subir-comentario-documento">Subir</button>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="tablero" class="h-100 d-flex flex-row flex-nowrap position-absolute">
    {% for fase in fases %}
    <div class="card m-3">
        <div class="card-header">
            Fase {{ forloop.counter }}: {{ fase.nombre }}
        </div>
        <div class="card-body contenedor h-100" data-fase-pk="{{ fase.pk }}">
            {% for candidato in fase.candidato_set.all %}
            <div class="card m-2 candidato-card" data-candidato-pk="{{ candidato.pk }}">
                <div class="card-body">
                    <h5 class="card-title">{{ candidato.nombres }} {{ candidato.apellidos }}</h5>
                    <h6 class="card-subtitle mb-2 text-body-secondary">Puesto deseado: {{ candidato.puesto_deseado }}
                    </h6>
                    <p class="card-text">Fecha de inicio de proceso: {{ candidato.agregado_el }}</p>
                    <button data-candidato-id="{{ candidato.pk }}"
                        class="toggle-candidato btn btn-secondary btn-sm card-link" data-bs-toggle="modal"
                        data-bs-target="#candidatoModal">Ver Candidato</button>
                    <button data-candidato-pk="{{ candidato.pk }}"
                        data-nombre-candidato="{{ candidato.nombres }} {{ candidato.apellidos }}"
                        class="btn btn-danger btn-sm card-link eliminar-candidato" data-bs-toggle="modal"
                        data-bs-target="#eliminarCandidatoModal">Eliminar Candidato</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

{% endblock content %}
{% block js_scripts %}
<script src='https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.js'></script>
<script>
    $(window).on("load", function () {
        var kind = "comentario";
        var current_candidato_id = null;
        var drake = dragula({
            containers: $(".contenedor").toArray(),
            copy: false
        });
        drake.on("drop", (el, handle) => {
            var candidato_id = $(el).data("candidato-pk");
            var fase_id = $(handle).data("fase-pk");
            var url = window.location.origin + `/api/cambiar_fase/${candidato_id}/${fase_id}/`;
            fetch(url, {})
                .then(res => res.json())
                .then((res) => {
                    if (res.messages.length != 0) {
                        var composed_mensajes = "";
                        for (var i = 0; i < res.messages.length; i++) {
                            composed_mensajes += res.messages[i] + "\n";
                        }
                        alert(`Se detectaron los siguientes errores:\n${composed_mensajes}`);
                    }
                })
                .catch(err => console.error(err));
        });
        $(".nav-link").on("click", function (evt) {
            kind = $(evt.target).data("kind");
        });
        $(".form-nuevo-candidato").on("submit", function (e) {
            e.preventDefault();
            var payload = {
                tablero_asignado: parseInt("{{ object.pk }}"),
                nombres: $("#nombre-candidato").val(),
                apellidos: $("#apellidos-candidato").val(),
                puesto_deseado: $("#puesto-deseado").val(),
                fecha_de_nacimiento: $("#fecha-de-nacimiento").val(),
                email: $("#email").val(),
                telefono: $("#telefono").val(),
                estado_civil: $("#edo_civil").val(),
            }
            fetch("{% url 'api_candidato' %}", {
                method: "POST",
                body: JSON.stringify(
                    payload
                ),
                headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json" }
            })
                .then(res => res.json())
                .then((res) => {
                    if (res.messages.length == 0) {
                        alert("Candidato creado!");
                        window.location.href = "{% url 'tablero' object.pk %}";
                    } else {
                        var composed_mensajes = "";
                        for (var i = 0; i < res.messages.length; i++) {
                            composed_mensajes += res.messages[i] + "\n";
                        }
                        alert(`Se detectaron los siguientes errores:\n${composed_mensajes}`);
                    }
                })
                .catch(err => console.error(err));
        });

        var candidato_a_eliminar = null;
        var nombre_candidato_a_eliminar = null;
        $(".eliminar-candidato").on("click", function (e) {
            candidato_a_eliminar = $(e.target).data("candidato-pk");
            nombre_candidato_a_eliminar = $(e.target).data("nombre-candidato");
            var url = window.location.origin + `/api/candidato/${candidato_a_eliminar}/`;
            $("#nombre-del-candidato-a-eliminar").html(nombre_candidato_a_eliminar);
            $("#boton-eliminar-candidato").off("click")
            $("#boton-eliminar-candidato").on("click", function() {
                fetch(url, {
                    method: "DELETE",
                    headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json" }
                })
                    .then(res => res.json())
                    .then((res) => {
                        if (res.messages.length == 0) {
                            alert("Candidato eliminado!");
                            window.location.href = "{% url 'tablero' object.pk %}";
                        } else {
                            var composed_mensajes = "";
                            for (var i = 0; i < res.messages.length; i++) {
                                composed_mensajes += res.messages[i] + "\n";
                            }
                            alert(`Se detectaron los siguientes errores:\n${composed_mensajes}`);
                        }
                    })
                    .catch(err => console.error(err));
            });
        });
        $(".form-editar-candidato").on("submit", function (e) {
            e.preventDefault();
            var payload = {
                current_candidato_id: current_candidato_id,
                nombres: $("#nombre-candidato-editar").val(),
                apellidos: $("#apellidos-candidato-editar").val(),
                puesto_deseado: $("#puesto-deseado-editar").val(),
                fecha_de_nacimiento: $("#fecha-de-nacimiento-editar").val(),
                email: $("#email-editar").val(),
                telefono: $("#telefono-editar").val(),
                estado_civil: $("#edo_civil-editar").val(),
            }
            fetch("{% url 'api_candidato' %}", {
                method: "PATCH",
                body: JSON.stringify(
                    payload
                ),
                headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json" }
            })
                .then(res => res.json())
                .then((res) => {
                    if (res.messages.length == 0) {
                        alert("Candidato modificado!");
                    } else {
                        var composed_mensajes = "";
                        for (var i = 0; i < res.messages.length; i++) {
                            composed_mensajes += res.messages[i] + "\n";
                        }
                        alert(`Se detectaron los siguientes errores:\n${composed_mensajes}`);
                    }
                })
                .catch(err => console.error(err));
        });
        function compare_dates(a, b) {
            if (a.creado_el < b.creado_el) {
                return -1;
            }
            if (a.creado_el > b.creado_el) {
                return 1;
            }
            return 0;
        }
        var elemento_a_eliminar = null;
        var tipo_a_eliminar = null;
        function load_eliminar() {
            $(".eliminar-archivo-comentario").on("click", function (e) {
                elemento_a_eliminar = $(e.target).data("pk");
                tipo =  $(e.target).data("tipo");
                var url = window.location.origin + `/api/eliminar/${tipo}/${elemento_a_eliminar}/`;
                $("#boton-eliminar-archivo-comentario").off("click");
                $("#boton-eliminar-archivo-comentario").on("click", function() {
                    fetch(url, {
                        method: "DELETE",
                        headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json" }
                    })
                        .then(res => res.json())
                        .then((res) => {
                            if (res.messages.length == 0) {
                                $(`.toggle-candidato[data-candidato-id="${current_candidato_id}"]`).click();
                            } else {
                                var composed_mensajes = "";
                                for (var i = 0; i < res.messages.length; i++) {
                                    composed_mensajes += res.messages[i] + "\n";
                                }
                                alert(`Se detectaron los siguientes errores:\n${composed_mensajes}`);
                            }
                        })
                        .catch(err => console.error(err));
                });
            });
        }
        function load_candidato(id_candidato) {
            var url = window.location.origin + `/api/candidato/${id_candidato}`;
            fetch(url, {})
                .then(res => res.json())
                .then((res) => {
                    if (res.messages.length == 0) {
                        var table_log = res.candidato.comentarios.concat(res.candidato.archivos);
                        table_log = table_log.sort(compare_dates);
                        $("#nombre-candidato-editar").val(res.candidato.nombres);
                        $("#apellidos-candidato-editar").val(res.candidato.apellidos);
                        $("#puesto-deseado-editar").val(res.candidato.puesto_deseado);
                        $("#fecha-de-nacimiento-editar").val(res.candidato.fecha_de_nacimiento);
                        $("#email-editar").val(res.candidato.email);
                        $("#telefono-editar").val(res.candidato.telefono);
                        $("#edo_civil-editar").val(res.candidato.estado_civil);
                        var texto = "";
                        for (var i = 0; i < table_log.length; i++) {
                            if (table_log[i].tipo == "COMENTARIO") {
                                texto += `<tr>
                                    <td>${table_log[i].creado_el}</td>
                                    <td>
                                        <b>${table_log[i].comentado_por} Comentó:</b><br>
                                        <p><i>${table_log[i].texto}</i></p>
                                    </td>
                                    <td>
                                        ${table_log[i].fase}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm eliminar-archivo-comentario" data-bs-toggle="modal"
                                            data-bs-target="#eliminarArchivoComentarioModal"
                                            data-pk="${table_log[i].pk}"
                                            data-tipo="comentario">❌</button>
                                    </td>
                                </tr>`;
                            } else {
                                texto += `<tr>
                                    <td>${table_log[i].creado_el}</td>
                                    <td>
                                        <b>${table_log[i].subido_por} Añadió:</b><br>
                                        <a target="_blank" href="${table_log[i].archivo}">${table_log[i].archivo_nombre}</a><br>
                                        <b>Descripción: </b>${table_log[i].descripcion}<br>
                                    </td>
                                    <td>
                                        ${table_log[i].fase}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm eliminar-archivo-comentario" data-bs-toggle="modal"
                                            data-bs-target="#eliminarArchivoComentarioModal"
                                            data-pk="${table_log[i].pk}"
                                            data-tipo="archivo">❌</button>
                                    </td>
                                </tr>`;
                            }
                        }
                        $(".resumen-comentarios-archivos").html(texto);
                        load_eliminar();
                    } else {
                        var composed_mensajes = "";
                        for (var i = 0; i < res.messages.length; i++) {
                            composed_mensajes += res.messages[i] + "\n";
                        }
                        alert(`Se detectaron los siguientes errores:\n${composed_mensajes}`);
                    }
                })
                .catch(err => console.error(err));
        }
        
        $(".toggle-candidato").on("click", function (evt) {
            var id_candidato = $(evt.target).data("candidato-id");
            current_candidato_id = id_candidato;
            load_candidato(id_candidato);
        });
        $(".subir-comentario-documento").on("click", function () {
            if (kind == "comentario") {
                if ($("#comentario-input").val() != "") {
                    var payload = {
                        comentado_por: parseInt("{{ request.user.pk }}"),
                        comentario: $("#comentario-input").val(),
                        fase: 1,
                        texto: $("#comentario-input").val(),
                        candidato: current_candidato_id,
                    };
                    fetch("{% url 'api_comentario' %}", {
                        method: "POST",
                        body: JSON.stringify(
                            payload
                        ),
                        headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json" }
                    })
                        .then(res => res.json())
                        .then((res) => {
                            if (res.messages.length == 0) {
                                load_candidato(current_candidato_id);
                                $("#comentario-input").val("");
                            } else {
                                var composed_mensajes = "";
                                for (var i = 0; i < res.messages.length; i++) {
                                    composed_mensajes += res.messages[i] + "\n";
                                }
                                alert(`Se detectaron los siguientes errores:\n${composed_mensajes}`);
                            }
                        })
                        .catch(err => console.error(err));
                } else {
                    alert("Por favor, completa el comentario.");
                }
            } else {
                if ($("#documento-input").val() != "" && $("#formFile").val() != "") {
                    var file_field = $("#formFile");
                    var form_data = new FormData();
                    form_data.append("subido_por", parseInt("{{ request.user.pk }}"));
                    form_data.append("fase", 1);
                    form_data.append("candidato", current_candidato_id);
                    form_data.append("archivo", file_field.prop("files")[0]);
                    form_data.append("descripcion", $("#documento-input").val());

                    fetch("{% url 'api_archivo' %}", {
                        method: "POST",
                        body: form_data,
                        headers: { "X-CSRFToken": "{{ csrf_token }}" }
                    })
                        .then(res => res.json())
                        .then((res) => {
                            if (res.messages.length == 0) {
                                load_candidato(current_candidato_id);
                                $("#documento-input").val("");
                                $("#formFile").val("");
                            } else {
                                var composed_mensajes = "";
                                for (var i = 0; i < res.messages.length; i++) {
                                    composed_mensajes += res.messages[i] + "\n";
                                }
                                alert(`Se detectaron los siguientes errores:\n${composed_mensajes}`);
                            }
                        })
                        .catch(err => console.error(err));
                } else {
                    alert("Por favor, completa el formulario de documento.");
                }
            }
        });
    });
</script>
{% endblock js_scripts %}
{% block style %}
<style>
    .candidato-card {
        cursor: pointer;
    }
</style>
{% endblock style %}